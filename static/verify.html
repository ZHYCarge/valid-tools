<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>存证验证</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="page">
      <div class="topbar">
        <div class="brand">
          <h1>存证验证</h1>
          <p>上传文件或文本，结合 OTS / TSA 凭证进行校验。</p>
        </div>
        <a class="nav-link" href="/static/index.html">返回首页</a>
      </div>

      <div class="grid">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">验证输入</h2>
            <span class="hint">可选上传凭证</span>
          </div>
          <form id="verifyForm" class="form">
            <div class="field">
              <label>选择文件</label>
              <input type="file" id="fileInput" />
            </div>
            <div class="field">
              <label>或输入文本</label>
              <textarea id="textInput" placeholder="在此粘贴需要验证的内容"></textarea>
            </div>
            <div class="field">
              <label>上传 OTS 凭证（可选）</label>
              <input type="file" id="otsInput" accept=".ots" />
            </div>
            <div class="field">
              <label>上传 TSA 凭证（可选）</label>
              <input type="file" id="tsaInput" accept=".tsr" />
            </div>
            <div class="field">
              <label>计算得到的 Hash</label>
              <input type="text" id="hashOutput" readonly />
            </div>
            <div class="options">
              <span>验证类型</span>
              <label><input type="checkbox" id="otsOption" checked /> OTS</label>
              <label><input type="checkbox" id="tsaOption" checked /> TSA</label>
            </div>
            <div class="row">
              <button type="submit" class="btn">开始验证</button>
            </div>
          </form>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">验证结果</h2>
            <span class="hint" id="statusLine">等待验证</span>
          </div>
          <div id="readable" class="status-grid"></div>
          <div class="divider"></div>
          <div id="jsonViewer" class="json-viewer"></div>
          <details>
            <summary class="hint">原始 JSON</summary>
            <pre id="output"></pre>
          </details>
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById("verifyForm");
      const output = document.getElementById("output");
      const jsonViewer = document.getElementById("jsonViewer");
      const statusLine = document.getElementById("statusLine");
      const readable = document.getElementById("readable");
      let calendarIndex = 0;
      let lastCalendarInfo = null;
      let lastVerifyData = null;

      async function sha256Hex(buffer) {
        const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
      }

      async function computeHash() {
        const file = document.getElementById("fileInput").files[0];
        const text = document.getElementById("textInput").value;
        if (file) {
          const buffer = await file.arrayBuffer();
          return sha256Hex(buffer);
        }
        if (text) {
          const buffer = new TextEncoder().encode(text);
          return sha256Hex(buffer);
        }
        return "";
      }

      function createBadge(text) {
        const badge = document.createElement("span");
        badge.className = "badge";
        const normalized = String(text).toLowerCase();
        if (normalized.includes("fail") || normalized.includes("error")) {
          badge.classList.add("danger");
        } else if (normalized.includes("disable")) {
          badge.classList.add("warn");
        }
        badge.textContent = text;
        return badge;
      }

      function createStatusCard(title, statusClass, rows) {
        const card = document.createElement("div");
        card.className = `status-card ${statusClass}`;
        const h3 = document.createElement("h3");
        h3.textContent = title;
        card.appendChild(h3);
        const list = document.createElement("div");
        list.className = "status-list";
        rows.forEach(([label, value]) => {
          const item = document.createElement("div");
          item.className = "status-item";
          const k = document.createElement("strong");
          k.textContent = label;
          const v = document.createElement("div");
          if (value instanceof Node) {
            v.appendChild(value);
          } else {
            v.textContent = value === null || value === undefined ? "-" : String(value);
          }
          item.appendChild(k);
          item.appendChild(v);
          list.appendChild(item);
        });
        card.appendChild(list);
        return card;
      }

      function buildInlineButtons(items) {
        const container = document.createElement("div");
        container.className = "inline-actions";
        items.forEach((item) => {
          if (item) {
            container.appendChild(item);
          }
        });
        return container;
      }

      function statusClassForResult(result) {
        if (!result) return "warn";
        if (result.success) return "success";
        const errorText = String(result.error || "").toLowerCase();
        if (errorText.includes("disable")) return "warn";
        if (errorText.includes("missing")) return "warn";
        return "error";
      }

      function buildExplorerButton(url) {
        if (!url) {
          return "-";
        }
        const link = document.createElement("a");
        link.href = url;
        link.target = "_blank";
        link.rel = "noopener";
        link.className = "inline-link";
        link.textContent = "查看区块";
        return link;
      }

      function pickRepresentativeProof(proofs) {
        if (!Array.isArray(proofs) || proofs.length === 0) {
          return null;
        }
        const sorted = proofs
          .slice()
          .sort((a, b) => (b.height || 0) - (a.height || 0));
        return sorted[0] || null;
      }

      function renderBlockchainProofs(info) {
        const proofs = info && info.blockchain_proofs;
        const proof = pickRepresentativeProof(proofs);
        if (!proof) {
          return null;
        }
        const rows = [];
        const calendarSummary = summarizeCalendars(info);
        rows.push(["链", proof.chain || "-"]);
        rows.push(["区块高度", proof.height ?? "-"]);
        rows.push(["区块哈希", proof.block_hash || "-"]);
        rows.push(["区块浏览器", buildExplorerButton(proof.explorer_url)]);
        if (calendarSummary) {
          rows.push(["日历通过/总数", calendarSummary]);
        }
        if (lastCalendarInfo) {
          const current = describeCalendarEntry(lastCalendarInfo);
          rows.push(["当前日历", current]);
        }
        const statusClass = proof.block_hash ? "success" : "warn";
        return createStatusCard("区块链证明", statusClass, rows);
      }

      function summarizeCalendars(info) {
        const results = info && info.calendar_results;
        if (!Array.isArray(results) || results.length === 0) {
          return null;
        }
        const passed = results.filter((item) => item && item.success).length;
        return `${passed}/${results.length}`;
      }

      function describeCalendarEntry(entry) {
        if (!entry) return "-";
        const uri = entry.uri || "unknown";
        if (entry.success) {
          const summary = entry.summary || {};
          const att = summary.attestations ?? "-";
          const types = Array.isArray(summary.attestation_types)
            ? summary.attestation_types.join(",")
            : "-";
          return `${uri}（success，attestations=${att}，types=${types}）`;
        }
        const err = entry.error || "failed";
        return `${uri}（error，${err}）`;
      }

      function renderCalendarResults(info) {
        const results = info && info.calendar_results;
        if (!Array.isArray(results) || results.length === 0) {
          lastCalendarInfo = null;
          return null;
        }
        if (calendarIndex < 0) calendarIndex = 0;
        if (calendarIndex >= results.length) calendarIndex = results.length - 1;
        lastCalendarInfo = results[calendarIndex];
        const rows = [];
        rows.push(["服务器", lastCalendarInfo.uri || "-"]);
        rows.push(["进度", `${calendarIndex + 1} / ${results.length}`]);
        rows.push([
          "状态",
          lastCalendarInfo.success ? "success" : "failed",
        ]);
        if (lastCalendarInfo.success) {
          const summary = lastCalendarInfo.summary || {};
          rows.push(["attestations", summary.attestations ?? "-"]);
          rows.push([
            "types",
            Array.isArray(summary.attestation_types)
              ? summary.attestation_types.join(",")
              : "-",
          ]);
        } else {
          rows.push(["错误信息", lastCalendarInfo.error || "-"]);
        }
        const prevBtn = document.createElement("button");
        prevBtn.type = "button";
        prevBtn.className = "btn ghost small";
        prevBtn.textContent = "← 上一个";
        prevBtn.disabled = calendarIndex === 0;
        prevBtn.addEventListener("click", () => {
          calendarIndex = Math.max(0, calendarIndex - 1);
          renderReadable(lastVerifyData);
        });
        const nextBtn = document.createElement("button");
        nextBtn.type = "button";
        nextBtn.className = "btn ghost small";
        nextBtn.textContent = "下一个 →";
        nextBtn.disabled = calendarIndex >= results.length - 1;
        nextBtn.addEventListener("click", () => {
          calendarIndex = Math.min(results.length - 1, calendarIndex + 1);
          renderReadable(lastVerifyData);
        });
        rows.push(["选择", buildInlineButtons([prevBtn, nextBtn])]);
        const statusClass = lastCalendarInfo.success ? "success" : "warn";
        return createStatusCard("日历服务器响应", statusClass, rows);
      }

      function otsTrustInfo(result) {
        if (!result || !result.success) {
          return { level: "未通过验证", className: statusClassForResult(result) };
        }
        const info = result.info || {};
        if (info.has_blockchain_proof) {
          return { level: "强可信（已上链）", className: "success" };
        }
        if (info.has_pending_attestations) {
          return { level: "弱可信（仅日历服务器）", className: "warn" };
        }
        return { level: "弱可信（缺少区块链证明）", className: "warn" };
      }

      function renderReadable(data) {
        readable.innerHTML = "";
        if (!data || typeof data !== "object") {
          return;
        }
        lastVerifyData = data;
        if (data.ots) {
          const otsTrust = otsTrustInfo(data.ots);
          const otsCard = createStatusCard(
            "OTS 验证",
            otsTrust.className,
            [
              ["是否成功", data.ots.success ? "是" : "否"],
              ["可信度", otsTrust.level],
              ["错误信息", data.ots.error || "-"],
            ]
          );
          readable.appendChild(otsCard);

          const calendarCard = renderCalendarResults(data.ots.info);
          if (calendarCard) {
            readable.appendChild(calendarCard);
          }

          const proofCard = renderBlockchainProofs(data.ots.info);
          if (proofCard) {
            readable.appendChild(proofCard);
          }
        }

        if (data.tsa) {
          const tsaCard = createStatusCard(
            "TSA 验证",
            statusClassForResult(data.tsa),
            [
              ["是否成功", data.tsa.success ? "是" : "否"],
              ["错误信息", data.tsa.error || "-"],
            ]
          );
          readable.appendChild(tsaCard);
        }
      }

      function renderJsonViewer(data) {
        jsonViewer.innerHTML = "";
        if (!data || typeof data !== "object") {
          jsonViewer.textContent = String(data || "");
          return;
        }
        Object.entries(data).forEach(([key, value]) => {
          const line = document.createElement("div");
          line.className = "json-line";
          const k = document.createElement("div");
          k.className = "json-key";
          k.textContent = key;
          const v = document.createElement("div");
          v.className = "json-value";
          if (key.endsWith("status")) {
            v.appendChild(createBadge(value));
          } else if (value && typeof value === "object") {
            v.textContent = JSON.stringify(value);
          } else {
            v.textContent = value === null || value === undefined ? "-" : String(value);
          }
          line.appendChild(k);
          line.appendChild(v);
          jsonViewer.appendChild(line);
        });
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const body = new FormData();
        const hash = await computeHash();
        const otsEnabled = document.getElementById("otsOption").checked;
        const tsaEnabled = document.getElementById("tsaOption").checked;
        if (!hash) {
          statusLine.textContent = "请上传文件或输入文本";
          return;
        }
        if (!otsEnabled && !tsaEnabled) {
          statusLine.textContent = "请选择 OTS 或 TSA";
          return;
        }
        const otsFile = document.getElementById("otsInput").files[0];
        const tsaFile = document.getElementById("tsaInput").files[0];
        document.getElementById("hashOutput").value = hash;
        body.append("hash_value", hash);
        body.append("ots_option", otsEnabled ? "enable" : "disable");
        body.append("tsa_option", tsaEnabled ? "enable" : "disable");
        if (otsFile) {
          body.append("ots_file", otsFile);
        }
        if (tsaFile) {
          body.append("tsa_file", tsaFile);
        }
        statusLine.textContent = "验证中...";
        const resp = await fetch("/api/evidence/verify", {
          method: "POST",
          body,
        });
        if (!resp.ok) {
          const data = await resp.json();
          if (data.detail === "ots file required when record missing") {
            alert("数据库未找到记录，请上传 OTS 凭证文件");
          } else if (data.detail === "tsa file required when record missing") {
            alert("数据库未找到记录，请上传 TSA 凭证文件");
          } else {
            alert(data.detail || "验证失败");
          }
          statusLine.textContent = "验证失败";
          output.textContent = JSON.stringify(data, null, 2);
          renderReadable(data);
          renderJsonViewer(null);
          return;
        }
        const data = await resp.json();
        output.textContent = JSON.stringify(data, null, 2);
        renderReadable(data);
        renderJsonViewer(null);
        statusLine.textContent = "验证完成";
      });
    </script>
  </body>
</html>
